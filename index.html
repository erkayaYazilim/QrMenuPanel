<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>QR Menü Admin Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- Firebase SDK (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  
  <!-- Stil Tanımları -->
  <style>
    :root {
      --primary-color: #007bff;
      --secondary-color: #ffba00;
      --light-gray: #f4f6f9;
      --border-color: #ced4da;
    }
    /* Genel Ayarlar */
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: var(--light-gray);
      margin: 0;
      padding: 0;
      color: #343a40;
    }
    /* Giriş Ekranı */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    .login-container h2 {
      margin-bottom: 20px;
    }
    .login-container input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .login-container input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }
    .login-container button {
      width: 100%;
      padding: 12px;
      background-color: var(--secondary-color);
      border: none;
      border-radius: 4px;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .login-container button:hover {
      background-color: #e0a800;
    }
    /* Admin Paneli Genel */
    #adminContent {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    header.header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      padding: 15px 20px;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 20px;
    }
    header.header h1 {
      color: var(--primary-color);
      margin: 0;
      font-size: 24px;
    }
    .logout-button {
      background-color: #dc3545;
      color: #fff;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .logout-button:hover {
      background-color: #c82333;
    }
    /* Sekme Navigasyonu */
    .tab-nav {
      display: flex;
      flex-wrap: wrap;
      background-color: #fff;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 20px;
    }
    .tab-nav button {
      flex: 1;
      padding: 15px;
      border: none;
      background-color: var(--light-gray);
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    .tab-nav button.active {
      background-color: #fff;
      border-bottom: 3px solid var(--primary-color);
      font-weight: bold;
    }
    /* Tab İçerikleri */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Ana Bölümler */
    main section {
      background-color: #fff;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    main section h2 {
      color: var(--primary-color);
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 10px;
    }
    main section form {
      margin-top: 20px;
    }
    main section form label {
      display: block;
      margin-bottom: 5px;
      color: #495057;
    }
    main section form input,
    main section form select {
      width: 100%;
      padding: 10px;
      margin: 6px 0 15px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    main section form input:focus,
    main section form select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 5px rgba(0,123,255,0.5);
    }
    main section form button {
      background-color: var(--primary-color);
      color: #fff;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    main section form button:hover {
      background-color: #0069d9;
    }
    /* Kategori Listeleme */
    #sortableCategories {
      list-style-type: none;
      padding: 0;
      margin: 0 0 20px 0;
    }
    .category-item {
      padding: 10px;
      margin: 5px 0;
      background-color: #f0f0f0;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: move;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .category-item button {
      margin-left: 10px;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .category-item button:first-of-type {
      background-color: #28a745;
      color: #fff;
    }
    .category-item button:last-of-type {
      background-color: #dc3545;
      color: #fff;
    }
    .category-item button:first-of-type:hover {
      background-color: #218838;
    }
    .category-item button:last-of-type:hover {
      background-color: #c82333;
    }
    /* Ürün Listeleme */
    #productsList {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .product-item {
      display: flex;
      align-items: center;
      background-color: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .product-item img {
      width: 80px;
      height: auto;
      margin-right: 15px;
      border-radius: 5px;
      object-fit: cover;
    }
    .product-item span {
      flex: 1;
      font-size: 18px;
      color: #343a40;
    }
    .product-item button {
      background-color: #28a745;
      color: #fff;
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      transition: background-color 0.3s;
    }
    .product-item button:hover {
      background-color: #218838;
    }
    .product-item .delete-button {
      background-color: #dc3545;
    }
    .product-item .delete-button:hover {
      background-color: #c82333;
    }
    /* Modal Genel Stil */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow-y: auto;
      background-color: rgba(0,0,0,0.5);
    }
    /* Gelişmiş Modal Tasarımı */
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      border-radius: 8px;
      max-width: 600px;
      position: relative;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(-20px);}
      to {opacity: 1; transform: translateY(0);}
    }
    .modal-header {
      background-color: var(--primary-color);
      color: #fff;
      padding: 15px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      font-size: 20px;
      position: relative;
    }
    .modal-header .close {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 28px;
      cursor: pointer;
      color: #fff;
    }
    .modal-body {
      padding: 20px;
    }
    /* İlerleme Çubuğu */
    .progress-bar {
      width: 100%;
      background-color: #e9ecef;
      margin-top: 10px;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 20px;
      background-color: var(--primary-color);
      width: 0%;
      text-align: center;
      color: white;
      line-height: 20px;
    }
    /* Mobil Duyarlılık */
    @media (max-width: 768px) {
      .tab-nav button {
        font-size: 14px;
        padding: 10px;
      }
      .product-item, .category-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .product-item button, .category-item button {
        width: 100%;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Giriş Ekranı -->
  <div id="loginDiv" class="login-container">
    <h2>Admin Girişi</h2>
    <input type="email" id="email" placeholder="E-posta" required>
    <input type="password" id="password" placeholder="Şifre" required>
    <button onclick="login()">Giriş Yap</button>
  </div>

  <!-- Admin Paneli İçeriği -->
  <div id="adminContent">
    <header class="header">
      <h1>QR Menü Admin Paneli</h1>
      <button onclick="logout()" class="logout-button">Çıkış Yap</button>
    </header>
    
    <!-- Sekme Navigasyonu (4 Sekme) -->
    <div class="tab-nav">
      <button id="btnCategories" class="active" onclick="switchTab('categories')">Kategoriler</button>
      <button id="btnAddCategory" onclick="switchTab('addCategory')">Kategori Ekle</button>
      <button id="btnProducts" onclick="switchTab('products')">Ürünler</button>
      <button id="btnAddProduct" onclick="switchTab('addProduct')">Ürün Ekle</button>
    </div>
    
    <!-- Sekme İçerikleri -->
    <div id="tabCategories" class="tab-content active">
      <main>
        <section id="categorySection">
          <h2>Kategoriler</h2>
          <ul id="sortableCategories"></ul>
        </section>
      </main>
    </div>
    
    <div id="tabAddCategory" class="tab-content">
      <main>
        <section id="addCategorySection">
          <h2>Yeni Kategori Ekle</h2>
          <form id="newCategoryForm">
            <label for="categoryName_tr">Kategori İsmi (TR)</label>
            <input type="text" id="categoryName_tr" placeholder="Kategori Adı (TR)" required>
            <label for="categoryName_en">Kategori İsmi (EN)</label>
            <input type="text" id="categoryName_en" placeholder="Kategori Adı (EN)" required>
            <label for="categoryImage">Kategori Resmi</label>
            <input type="file" id="categoryImage" accept="image/*" required>
            <img id="categoryImagePreview" src="#" alt="Kategori Resmi" style="display:none; max-width:200px; margin-top:10px;">
            <div class="progress-bar" id="categoryProgressBar" style="display:none;">
              <div class="progress-bar-fill" id="categoryProgressBarFill">0%</div>
            </div>
            <button type="submit">Kategori Ekle</button>
          </form>
        </section>
      </main>
    </div>
    
    <div id="tabProducts" class="tab-content">
      <main>
        <section id="productSection">
          <h2>Ürünler</h2>
          <div id="productFilter">
            <label for="filterCategory">Kategori Seçin:</label>
            <select id="filterCategory">
              <option value="">Hepsi</option>
            </select>
          </div>
          <div id="productsList"></div>
        </section>
      </main>
    </div>
    
    <div id="tabAddProduct" class="tab-content">
      <main>
        <section id="addProductSection">
          <h2>Yeni Ürün Ekle</h2>
          <form id="newProductForm">
            <label for="productName_tr">Ürün İsmi (TR)</label>
            <input type="text" id="productName_tr" placeholder="Ürün İsmi (TR)" required>
            <label for="productName_en">Ürün İsmi (EN)</label>
            <input type="text" id="productName_en" placeholder="Ürün İsmi (EN)" required>
            <label for="productDesc_tr">Ürün Açıklaması (TR)</label>
            <input type="text" id="productDesc_tr" placeholder="Ürün Açıklaması (TR)" required>
            <label for="productDesc_en">Ürün Açıklaması (EN)</label>
            <input type="text" id="productDesc_en" placeholder="Ürün Açıklaması (EN)" required>
            <label for="productPrice">Fiyat</label>
            <input type="number" id="productPrice" placeholder="Fiyat" required>
            <label for="productCategory">Kategori</label>
            <select id="productCategory" required>
              <option value="">Kategori Seçin</option>
            </select>
            <label for="fileElem">Ürün Resmi</label>
            <input type="file" id="fileElem" accept="image/*" required>
            <img id="productImagePreview" src="#" alt="Ürün Resmi" style="display:none; max-width:200px; margin-top:10px;">
            <div class="progress-bar" id="productProgressBar" style="display:none;">
              <div class="progress-bar-fill" id="productProgressBarFill">0%</div>
            </div>
            <button type="submit">Ürün Ekle</button>
          </form>
        </section>
      </main>
    </div>
    
  </div>

  <!-- Ürün Güncelleme Modalı (Gelişmiş Tasarım) -->
  <div id="updateProductModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        Ürünü Güncelle
        <span class="close" id="closeModal">&times;</span>
      </div>
      <div class="modal-body">
        <form id="updateProductForm">
          <input type="hidden" id="updateProductId">
          <label for="updateProductName_tr">Ürün İsmi (TR)</label>
          <input type="text" id="updateProductName_tr" placeholder="Ürün İsmi (TR)" required>
          <label for="updateProductName_en">Ürün İsmi (EN)</label>
          <input type="text" id="updateProductName_en" placeholder="Ürün İsmi (EN)" required>
          <label for="updateProductDesc_tr">Ürün Açıklaması (TR)</label>
          <input type="text" id="updateProductDesc_tr" placeholder="Ürün Açıklaması (TR)" required>
          <label for="updateProductDesc_en">Ürün Açıklaması (EN)</label>
          <input type="text" id="updateProductDesc_en" placeholder="Ürün Açıklaması (EN)" required>
          <label for="updateProductPrice">Fiyat</label>
          <input type="number" id="updateProductPrice" placeholder="Fiyat" required>
          <label for="updateProductCategory">Kategori</label>
          <select id="updateProductCategory" required>
            <option value="">Kategori Seçin</option>
          </select>
          <label for="updateFileElem">Ürün Resmi</label>
          <input type="file" id="updateFileElem" accept="image/*">
          <img id="updateProductImagePreview" src="#" alt="Ürün Resmi" style="display:none; max-width:200px; margin-top:10px;">
          <div class="progress-bar" id="updateProgressBar" style="display:none;">
            <div class="progress-bar-fill" id="updateProgressBarFill">0%</div>
          </div>
          <button type="submit">Güncelle</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Kategori Güncelleme Modalı (Gelişmiş Tasarım) -->
  <div id="updateCategoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        Kategoriyi Güncelle
        <span class="close" id="closeCategoryModal">&times;</span>
      </div>
      <div class="modal-body">
        <form id="updateCategoryForm">
          <input type="hidden" id="updateCategoryId">
          <label for="updateCategoryName_tr">Kategori İsmi (TR)</label>
          <input type="text" id="updateCategoryName_tr" placeholder="Kategori İsmi (TR)" required>
          <label for="updateCategoryName_en">Kategori İsmi (EN)</label>
          <input type="text" id="updateCategoryName_en" placeholder="Kategori İsmi (EN)" required>
          <label for="updateCategoryImage">Kategori Resmi</label>
          <input type="file" id="updateCategoryImage" accept="image/*">
          <img id="updateCategoryImagePreview" src="#" alt="Kategori Resmi" style="display:none; max-width:200px; margin-top:10px;">
          <div class="progress-bar" id="updateCategoryProgressBar" style="display:none;">
            <div class="progress-bar-fill" id="updateCategoryProgressBarFill">0%</div>
          </div>
          <label for="updateCategoryStatus">Durum</label>
          <select id="updateCategoryStatus" required>
            <option value="active">Aktif</option>
            <option value="inactive">Askıda</option>
          </select>
          <button type="submit">Güncelle</button>
        </form>
      </div>
    </div>
  </div>

  <!-- JavaScript Kodları -->
  <script>
    /* Firebase Yapılandırması */
    const firebaseConfig = {
      apiKey: "AIzaSyA16M_6xOrUGEn9YCdzIFxBYXr-9ST7IWY",
      authDomain: "qrmenuapplication-9b920.firebaseapp.com",
      databaseURL: "https://qrmenuapplication-9b920-default-rtdb.firebaseio.com",
      projectId: "qrmenuapplication-9b920",
      storageBucket: "qrmenuapplication-9b920.appspot.com",
      messagingSenderId: "1050979828232",
      appId: "1:1050979828232:web:54d81e21056193bee147bd",
      measurementId: "G-C3S611TREX"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const storage = firebase.storage();
    const auth = firebase.auth();

    /* Yardımcı Fonksiyonlar */
    function dataURItoBlob(dataURI) {
      const byteString = atob(dataURI.split(',')[1]);
      const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);
      for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
      }
      return new Blob([ab], { type: mimeString });
    }

    function resizeAndCompressImage(file, maxWidth, maxHeight, quality, callback) {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = function(event) {
        const img = new Image();
        img.src = event.target.result;
        img.onload = function() {
          let canvas = document.createElement('canvas');
          let ctx = canvas.getContext('2d');
          let width = img.width;
          let height = img.height;
          if (width > maxWidth || height > maxHeight) {
            if (width / height > maxWidth / maxHeight) {
              height = height * (maxWidth / width);
              width = maxWidth;
            } else {
              width = width * (maxHeight / height);
              height = maxHeight;
            }
          }
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          const dataURL = canvas.toDataURL('image/jpeg', quality);
          callback(dataURL);
        };
      };
    }

    /* Giriş ve Çıkış İşlemleri */
    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          document.getElementById('loginDiv').style.display = 'none';
          document.getElementById('adminContent').style.display = 'block';
          loadCategories();
          loadProducts();
        })
        .catch(error => {
          alert("Giriş başarısız: " + error.message);
        });
    }
    function logout() {
      auth.signOut().then(() => {
        document.getElementById('loginDiv').style.display = 'block';
        document.getElementById('adminContent').style.display = 'none';
      });
    }

    /* Sekme Navigasyonu (4 Sekme) */
    function switchTab(tab) {
      const tabs = ["categories", "addCategory", "products", "addProduct"];
      tabs.forEach(t => {
        document.getElementById("btn" + capitalize(t)).classList.remove("active");
        document.getElementById("tab" + capitalize(t)).classList.remove("active");
      });
      document.getElementById("btn" + capitalize(tab)).classList.add("active");
      document.getElementById("tab" + capitalize(tab)).classList.add("active");
    }
    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    /* Kategorilerle İlgili İşlemler */
    function loadCategories() {
      const sortableList = document.getElementById('sortableCategories');
      const productCategorySelect = document.getElementById('productCategory');
      const filterCategorySelect = document.getElementById('filterCategory');
      const updateProductCategorySelect = document.getElementById('updateProductCategory');
      sortableList.innerHTML = '';
      productCategorySelect.innerHTML = '<option value="">Kategori Seçin</option>';
      filterCategorySelect.innerHTML = '<option value="">Hepsi</option>';
      if(updateProductCategorySelect) updateProductCategorySelect.innerHTML = '<option value="">Kategori Seçin</option>';

      database.ref('Categories6').orderByChild('order').once('value', snapshot => {
        snapshot.forEach(childSnapshot => {
          const category = childSnapshot.val();
          const categoryId = childSnapshot.key;
          const categoryName = category.name_tr;
          const categoryStatus = category.status || 'active';

          let li = document.createElement('li');
          li.className = 'category-item';
          li.setAttribute('data-id', categoryId);
          let infoDiv = document.createElement('div');
          infoDiv.textContent = categoryName;
          if (categoryStatus === 'inactive') {
            infoDiv.style.color = 'gray';
            infoDiv.textContent += ' (Askıda)';
          }
          let editBtn = document.createElement('button');
          editBtn.textContent = 'Düzenle';
          editBtn.onclick = () => openUpdateCategoryModal(categoryId);
          let deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Sil';
          deleteBtn.onclick = () => deleteCategory(categoryId);
          li.append(infoDiv, editBtn, deleteBtn);
          sortableList.appendChild(li);

          if (categoryStatus === 'active') {
            let option = document.createElement('option');
            option.value = categoryId;
            option.textContent = categoryName;
            productCategorySelect.appendChild(option);
            let filterOption = document.createElement('option');
            filterOption.value = categoryId;
            filterOption.textContent = categoryName;
            filterCategorySelect.appendChild(filterOption);
            if(updateProductCategorySelect) {
              let updateOption = document.createElement('option');
              updateOption.value = categoryId;
              updateOption.textContent = categoryName;
              updateProductCategorySelect.appendChild(updateOption);
            }
          }
        });
        new Sortable(sortableList, {
          animation: 150,
          onEnd: updateCategoryOrder
        });
      });
    }
    function updateCategoryOrder(evt) {
      const items = evt.to.children;
      for (let i = 0; i < items.length; i++) {
        const categoryId = items[i].getAttribute('data-id');
        database.ref('Categories6/' + categoryId).update({ order: i });
      }
    }
    document.getElementById('newCategoryForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const name_tr = document.getElementById('categoryName_tr').value;
      const name_en = document.getElementById('categoryName_en').value;
      const imageFile = document.getElementById('categoryImage').files[0];
      document.getElementById('categoryProgressBar').style.display = 'block';
      resizeAndCompressImage(imageFile, 800, 800, 0.7, function(dataUrl) {
        const blob = dataURItoBlob(dataUrl);
        const storageRef = storage.ref('categoryImages6/' + imageFile.name);
        const uploadTask = storageRef.put(blob);
        uploadTask.on('state_changed',
          snapshot => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById('categoryProgressBarFill').style.width = progress + '%';
            document.getElementById('categoryProgressBarFill').textContent = Math.round(progress) + '%';
          },
          error => {
            alert('Yükleme hatası: ' + error.message);
          },
          () => {
            uploadTask.snapshot.ref.getDownloadURL().then(url => {
              database.ref('Categories6').once('value').then(snapshot => {
                const categoryCount = snapshot.numChildren();
                const newKey = database.ref().child('Categories6').push().key;
                database.ref('Categories6/' + newKey).set({
                  name_tr: name_tr,
                  name_en: name_en,
                  imageUrl: url,
                  order: categoryCount,
                  status: 'active'
                }).then(() => {
                  alert('Kategori başarıyla eklendi!');
                  document.getElementById('newCategoryForm').reset();
                  document.getElementById('categoryImagePreview').style.display = 'none';
                  document.getElementById('categoryProgressBar').style.display = 'none';
                  loadCategories();
                });
              });
            });
          }
        );
      });
    });
    function deleteCategory(categoryId) {
      if (confirm("Bu kategoriyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.")) {
        database.ref('Products6').orderByChild('categoryId').equalTo(categoryId).once('value', snapshot => {
          snapshot.forEach(childSnapshot => {
            database.ref('Products6/' + childSnapshot.key).remove();
          });
          database.ref('Categories6/' + categoryId).remove()
            .then(() => {
              alert("Kategori ve ilgili ürünler başarıyla silindi!");
              loadCategories();
              loadProducts();
            })
            .catch(error => {
              alert("Silme hatası: " + error.message);
            });
        });
      }
    }
    function openUpdateCategoryModal(categoryId) {
      document.getElementById('updateCategoryModal').style.display = 'block';
      database.ref('Categories6/' + categoryId).once('value', snapshot => {
        const category = snapshot.val();
        document.getElementById('updateCategoryId').value = categoryId;
        document.getElementById('updateCategoryName_tr').value = category.name_tr;
        document.getElementById('updateCategoryName_en').value = category.name_en || '';
        document.getElementById('updateCategoryStatus').value = category.status || 'active';
        const preview = document.getElementById('updateCategoryImagePreview');
        preview.src = category.imageUrl;
        preview.style.display = 'block';
      });
    }
    document.getElementById('updateCategoryImage').addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        resizeAndCompressImage(file, 800, 800, 0.7, function(dataUrl) {
          const preview = document.getElementById('updateCategoryImagePreview');
          preview.src = dataUrl;
          preview.style.display = 'block';
        });
      }
    });
    document.getElementById('updateCategoryForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const categoryId = document.getElementById('updateCategoryId').value;
      const name_tr = document.getElementById('updateCategoryName_tr').value;
      const name_en = document.getElementById('updateCategoryName_en').value;
      const status = document.getElementById('updateCategoryStatus').value;
      const imageFile = document.getElementById('updateCategoryImage').files[0];
      document.getElementById('updateCategoryProgressBar').style.display = 'block';
      if (imageFile) {
        resizeAndCompressImage(imageFile, 800, 800, 0.7, function(dataUrl) {
          const blob = dataURItoBlob(dataUrl);
          const storageRef = storage.ref('categoryImages6/' + imageFile.name);
          const uploadTask = storageRef.put(blob);
          uploadTask.on('state_changed',
            snapshot => {
              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              document.getElementById('updateCategoryProgressBarFill').style.width = progress + '%';
              document.getElementById('updateCategoryProgressBarFill').textContent = Math.round(progress) + '%';
            },
            error => {
              alert('Yükleme hatası: ' + error.message);
            },
            () => {
              uploadTask.snapshot.ref.getDownloadURL().then(url => {
                updateCategory(categoryId, name_tr, name_en, url, status);
              });
            }
          );
        });
      } else {
        database.ref('Categories6/' + categoryId).once('value', snapshot => {
          const category = snapshot.val();
          updateCategory(categoryId, name_tr, name_en, category.imageUrl, status);
        });
      }
    });
    function updateCategory(categoryId, name_tr, name_en, imageUrl, status) {
      database.ref('Categories6/' + categoryId).update({
        name_tr: name_tr,
        name_en: name_en,
        imageUrl: imageUrl,
        status: status
      }).then(() => {
        alert('Kategori başarıyla güncellendi!');
        document.getElementById('updateCategoryModal').style.display = 'none';
        document.getElementById('updateCategoryProgressBar').style.display = 'none';
        loadCategories();
        loadProducts();
      });
    }
    document.getElementById('closeCategoryModal').onclick = function() {
      document.getElementById('updateCategoryModal').style.display = 'none';
    };

    /* Ürünlerle İlgili İşlemler */
    function loadProducts() {
      const productsList = document.getElementById('productsList');
      productsList.innerHTML = '';
      const selectedCategory = document.getElementById('filterCategory').value;
      database.ref('Products6').once('value', snapshot => {
        snapshot.forEach(childSnapshot => {
          const product = childSnapshot.val();
          const productId = childSnapshot.key;
          if (selectedCategory === '' || selectedCategory === product.categoryId) {
            database.ref('Categories6/' + product.categoryId).once('value', categorySnapshot => {
              if (categorySnapshot.exists()) {
                const category = categorySnapshot.val();
                if (category.status === 'active') {
                  let div = document.createElement('div');
                  div.className = 'product-item';
                  div.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name_tr}">
                    <span>${product.name_tr} - ${category.name_tr}</span>
                    <button onclick="openUpdateModal('${productId}')">Güncelle</button>
                    <button onclick="deleteProduct('${productId}')" class="delete-button">🗑️</button>
                  `;
                  productsList.appendChild(div);
                }
              }
            });
          }
        });
      });
    }
    document.getElementById('filterCategory').addEventListener('change', loadProducts);
    document.getElementById('newProductForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const name_tr = document.getElementById('productName_tr').value;
      const name_en = document.getElementById('productName_en').value;
      const description_tr = document.getElementById('productDesc_tr').value;
      const description_en = document.getElementById('productDesc_en').value;
      const price = document.getElementById('productPrice').value;
      const categoryId = document.getElementById('productCategory').value;
      const imageFile = document.getElementById('fileElem').files[0];
      document.getElementById('productProgressBar').style.display = 'block';
      resizeAndCompressImage(imageFile, 800, 800, 0.7, function(dataUrl) {
        const blob = dataURItoBlob(dataUrl);
        const storageRef = storage.ref('productImages6/' + imageFile.name);
        const uploadTask = storageRef.put(blob);
        uploadTask.on('state_changed',
          snapshot => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById('productProgressBarFill').style.width = progress + '%';
            document.getElementById('productProgressBarFill').textContent = Math.round(progress) + '%';
          },
          error => {
            alert('Yükleme hatası: ' + error.message);
          },
          () => {
            uploadTask.snapshot.ref.getDownloadURL().then(url => {
              const newKey = database.ref().child('Products6').push().key;
              database.ref('Products6/' + newKey).set({
                name_tr: name_tr,
                name_en: name_en,
                description_tr: description_tr,
                description_en: description_en,
                price: price,
                categoryId: categoryId,
                imageUrl: url
              }).then(() => {
                alert('Ürün başarıyla eklendi!');
                document.getElementById('newProductForm').reset();
                document.getElementById('productImagePreview').style.display = 'none';
                document.getElementById('productProgressBar').style.display = 'none';
                loadProducts();
              });
            });
          }
        );
      });
    });
    document.getElementById('fileElem').addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        resizeAndCompressImage(file, 800, 800, 0.7, function(dataUrl) {
          const preview = document.getElementById('productImagePreview');
          preview.src = dataUrl;
          preview.style.display = 'block';
        });
      }
    });

    /* Ürün Güncelleme İşlemleri */
    function openUpdateModal(productId) {
      document.getElementById('updateFileElem').value = "";
      const preview = document.getElementById('updateProductImagePreview');
      preview.src = "";
      preview.style.display = 'none';
      document.getElementById('updateProductModal').style.display = 'block';
      database.ref('Products6/' + productId).once('value', snapshot => {
        const product = snapshot.val();
        document.getElementById('updateProductId').value = productId;
        document.getElementById('updateProductName_tr').value = product.name_tr;
        document.getElementById('updateProductName_en').value = product.name_en || '';
        document.getElementById('updateProductDesc_tr').value = product.description_tr;
        document.getElementById('updateProductDesc_en').value = product.description_en || '';
        document.getElementById('updateProductPrice').value = product.price;
        document.getElementById('updateProductCategory').value = product.categoryId;
        preview.src = product.imageUrl;
        preview.style.display = 'block';
      });
    }
    document.getElementById('updateFileElem').addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        resizeAndCompressImage(file, 800, 800, 0.7, function(dataUrl) {
          const preview = document.getElementById('updateProductImagePreview');
          preview.src = dataUrl;
          preview.style.display = 'block';
        });
      }
    });
    document.getElementById('updateProductForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const productId = document.getElementById('updateProductId').value;
      const name_tr = document.getElementById('updateProductName_tr').value;
      const name_en = document.getElementById('updateProductName_en').value;
      const description_tr = document.getElementById('updateProductDesc_tr').value;
      const description_en = document.getElementById('updateProductDesc_en').value;
      const price = document.getElementById('updateProductPrice').value;
      const categoryId = document.getElementById('updateProductCategory').value;
      const imageFile = document.getElementById('updateFileElem').files[0];
      document.getElementById('updateProgressBar').style.display = 'block';
      if (imageFile) {
        resizeAndCompressImage(imageFile, 800, 800, 0.7, function(dataUrl) {
          const blob = dataURItoBlob(dataUrl);
          const storageRef = storage.ref('productImages6/' + imageFile.name);
          const uploadTask = storageRef.put(blob);
          uploadTask.on('state_changed',
            snapshot => {
              const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              document.getElementById('updateProgressBarFill').style.width = progress + '%';
              document.getElementById('updateProgressBarFill').textContent = Math.round(progress) + '%';
            },
            error => {
              alert('Yükleme hatası: ' + error.message);
            },
            () => {
              uploadTask.snapshot.ref.getDownloadURL().then(url => {
                updateProduct(productId, name_tr, name_en, description_tr, description_en, price, categoryId, url);
              });
            }
          );
        });
      } else {
        database.ref('Products6/' + productId).once('value', snapshot => {
          const product = snapshot.val();
          updateProduct(productId, name_tr, name_en, description_tr, description_en, price, categoryId, product.imageUrl);
        });
      }
    });
    function updateProduct(productId, name_tr, name_en, description_tr, description_en, price, categoryId, imageUrl) {
      database.ref('Products6/' + productId).set({
        name_tr: name_tr,
        name_en: name_en,
        description_tr: description_tr,
        description_en: description_en,
        price: price,
        categoryId: categoryId,
        imageUrl: imageUrl
      }).then(() => {
        alert('Ürün başarıyla güncellendi!');
        document.getElementById('updateProductModal').style.display = 'none';
        document.getElementById('updateProgressBar').style.display = 'none';
        loadProducts();
      });
    }
    function deleteProduct(productId) {
      if (confirm("Bu ürünü silmek istediğinizden emin misiniz?")) {
        database.ref('Products6/' + productId).remove()
          .then(() => {
            alert("Ürün başarıyla silindi!");
            loadProducts();
          })
          .catch(error => {
            alert("Silme hatası: " + error.message);
          });
      }
    }
    document.getElementById('closeModal').onclick = function() {
      document.getElementById('updateProductModal').style.display = 'none';
    };

    /* Giriş Durumu */
    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
        loadCategories();
        loadProducts();
      } else {
        document.getElementById('loginDiv').style.display = 'block';
        document.getElementById('adminContent').style.display = 'none';
      }
    });
  </script>
</body>
</html>
